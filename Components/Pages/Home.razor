@page "/"
@using Quiz.Services
@using Quiz.Models
@using Microsoft.AspNetCore.SignalR.Client
@inject QuizService QuizService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>🎄 Christmas Quiz Challenge</PageTitle>

<div class="christmas-card">
    <div class="text-center">
        <h1 class="quiz-title">Christmas<br>Quiz</h1>
        <div class="alert alert-warning" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 15px; margin: 20px 0; font-size: 0.9rem;">
            <h2>🎅</h2> 
            <strong>Ho Ho Ho!</strong> <br />Don't hit refresh in your browser or you'll be removed from the game!<br>
            <small><em>'Tis a low budget development!</em></small>
        </div>
    </div>
    
    @if (!_gameStarted)
    {
        @if (!QuizService.GetGameState().IsActive)
        {
            <div class="text-center">
                <p class="mb-3">Waiting for Quiz Master to Start Game</p>
                <div style="font-size: 4rem; margin: 30px 0;">🕰️</div>
                <p class="text-muted">Please wait...</p>
            </div>
        }
        else
        {
            <div class="text-center">
                <h3>Enter a Lead Name and Join a Team Below</h3>
                <div class="mb-3">
                    <input @bind="_playerName" class="form-control mb-2" placeholder="Your name" style="max-width: 300px; margin: 0 auto;" />
                </div>
                
                <div class="mt-4">
                    <h5>Available Teams:</h5>
                    @foreach (var team in QuizService.GetTeams())
                    {
                        <button class="btn team-join-btn" 
                                @onclick="() => JoinExistingTeam(team.Name)" 
                                disabled="@string.IsNullOrWhiteSpace(_playerName)">
                            <span>@team.Name (@team.Players.Count players)</span>
                            <span class="join-badge">JOIN</span>
                        </button>
                    }
                </div>
            </div>
        }
    }
    else
    {

        
        <div class="text-center mb-3">
            <h4 style="color: var(--christmas-green); background: white; padding: 10px; border-radius: 10px; display: inline-block;">
                🎯 Playing as: <strong>@_currentTeam?.Name</strong>
            </h4>
        </div>
        
        @if (_currentQuestion != null)
        {
            <div class="question-card">
                <h4>Category: @_currentQuestion.Category</h4>
                <h3>@_currentQuestion.Question</h3>
                <div class="mt-4 d-grid gap-2">
                    @for (int i = 0; i < _currentQuestion.Options.Count; i++)
                    {
                        int optionIndex = i;
                        <button class="answer-btn" @onclick="async () => await SubmitAnswer(optionIndex)" disabled="@_hasAnswered">
                            @((char)('A' + i)). @_currentQuestion.Options[i]
                        </button>
                    }
                </div>
                @if (_hasAnswered)
                {
                    <p class="mt-3">✅ Answer submitted for <strong>@_currentTeam?.Name</strong>! Waiting for other teams...</p>
                }
            </div>
        }
        else
        {
            <div class="text-center">
                <h2>🎉 Quiz Complete! 🎉</h2>
                <p>Final scores are displayed above!</p>
            </div>
        }
    }
</div>

@code {
    private string _teamName = "";
    private string _playerName = "";
    private bool _gameStarted = false;
    private Team? _currentTeam;
    private Player? _currentPlayer;
    private QuizQuestion? _currentQuestion;
    private bool _hasAnswered = false;
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        _currentQuestion = QuizService.GetCurrentQuestion();
        _hasAnswered = false;
        
        try
        {
            var hubUrl = Navigation.ToAbsoluteUri("/quizhub");
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(hubUrl, options =>
                {
                    options.Transports = Microsoft.AspNetCore.Http.Connections.HttpTransportType.WebSockets | 
                                       Microsoft.AspNetCore.Http.Connections.HttpTransportType.LongPolling;
                })
                .WithAutomaticReconnect()
                .Build();

            _hubConnection.On("UpdateGame", () => InvokeAsync(StateHasChanged));
            _hubConnection.On("NextQuestion", () => {
                _currentQuestion = QuizService.GetCurrentQuestion();
                _hasAnswered = false;
                InvokeAsync(StateHasChanged);
            });
            _hubConnection.On("GameStarted", () => {
                _currentQuestion = QuizService.GetCurrentQuestion();
                _hasAnswered = false;
                InvokeAsync(StateHasChanged);
            });
            _hubConnection.On("GameReset", () => {
                _gameStarted = false;
                _hasAnswered = false;
                _currentTeam = null;
                _currentPlayer = null;
                _currentQuestion = QuizService.GetCurrentQuestion();
                InvokeAsync(StateHasChanged);
            });

            await _hubConnection.StartAsync();
        }
        catch
        {
            // SignalR failed, continue without real-time updates
        }
    }

    private async Task JoinTeam()
    {
        _currentTeam = QuizService.JoinTeam(_teamName, _playerName);
        _currentPlayer = _currentTeam.Players.First(p => p.Name == _playerName);
        _gameStarted = true;
        
        if (_hubConnection?.State == HubConnectionState.Connected)
        {
            try { await _hubConnection.SendAsync("UpdateGame"); } catch { }
        }
        
        StateHasChanged();
    }

    private void JoinExistingTeam(string teamName)
    {
        _teamName = teamName;
        _ = JoinTeam();
    }

    private async Task SubmitAnswer(int answerIndex)
    {
        if (_currentTeam != null && !_hasAnswered)
        {
            QuizService.SubmitAnswer(_currentTeam.Id, answerIndex);
            _hasAnswered = true;
            
            if (_hubConnection?.State == HubConnectionState.Connected)
            {
                try { await _hubConnection.SendAsync("UpdateGame"); } catch { }
            }
            
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
